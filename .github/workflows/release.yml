name: Release

on:
    push:
        tags:
            - "v*" # e.g., v1.2.3, v1.2.3-alpha

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                arch: [amd64, arm64]

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.25"

            - name: Determine version
              id: version
              shell: bash
              run: |
                  VERSION=$(git describe --tags --dirty --always || echo dev)
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "Determined version: $VERSION"

            - name: Create dist folder
              run: mkdir -p dist

            - name: Build binary
              shell: bash
              run: |
                  EXT=""
                  if [[ "$RUNNER_OS" == "Windows" ]]; then EXT=".exe"; fi

                  OS_NAME=""
                  case "$RUNNER_OS" in
                    "Windows") OS_NAME="windows" ;;
                    "Linux")   OS_NAME="linux" ;;
                    "macOS")   OS_NAME="darwin" ;;
                  esac

                  OUTFILE="dist/trovl_${OS_NAME}_${{ matrix.arch }}$EXT"
                  echo ">>> Building $OS_NAME/${{ matrix.arch }} :: $OUTFILE"

                  CGO_ENABLED=0 GOOS=$OS_NAME GOARCH=${{ matrix.arch }} \
                    go build -ldflags "-s -w -X main.version=$VERSION" -o "$OUTFILE" .

            - name: Upload binaries
              uses: actions/upload-artifact@v4
              with:
                  name: trovl-${{ matrix.os }}-${{ matrix.arch }}
                  path: dist/*

    checksums:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Download all build artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Flatten all binaries into dist/
              shell: bash
              run: |
                  mkdir -p dist
                  find artifacts -type f -exec cp {} dist/ \;

            - name: Generate SHA-256 checksums
              shell: bash
              run: |
                  cd dist
                  sha256sum * > checksums.txt || shasum -a 256 * > checksums.txt
                  cat checksums.txt

            - name: Upload checksums
              uses: actions/upload-artifact@v4
              with:
                  name: trovl-checksums
                  path: dist/checksums.txt

    release:
        runs-on: ubuntu-latest
        needs: [build, checksums]
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Download binaries and checksums
              uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Flatten files for release
              shell: bash
              run: |
                  mkdir -p dist_flat
                  find dist -type f -exec cp {} dist_flat/ \;

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  name: ${{ github.ref_name }}
                  files: dist_flat/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
