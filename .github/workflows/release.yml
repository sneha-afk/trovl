name: Release

on:
  push:
    tags:
      - "v*"

env:
  GO_VERSION: "1.25"

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version:
          - "1.21"
          - "1.22"
          - "1.23"
          - "1.24"
          - "1.25"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
      - name: Run tests
        run: go test -v ./...

  build:
    name: Build ${{ matrix.display_name }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            display_name: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            display_name: linux
            arch: arm64
            runner: ubuntu-latest
          - os: darwin
            display_name: macos
            arch: amd64
            runner: macos-latest
          - os: darwin
            display_name: macos
            arch: arm64
            runner: macos-latest
          - os: windows
            display_name: windows
            arch: amd64
            runner: windows-latest
          - os: windows
            display_name: windows
            arch: arm64
            runner: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build & package
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME#v}"
          EXT=""
          [[ "${{ matrix.os }}" == "windows" ]] && EXT=".exe"

          BINARY="trovl${EXT}"
          NAME="trovl_${{ matrix.display_name }}_${{ matrix.arch }}"

          CGO_ENABLED=0 GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} \
            go build -trimpath -ldflags "-s -w -X main.version=${VERSION}" -o "${BINARY}" .

          if [[ "${{ matrix.os }}" == "windows" ]]; then
            ARCHIVE="${NAME}.zip"
            if command -v zip &>/dev/null; then
              zip "${ARCHIVE}" "${BINARY}"
            else
              7z a "${ARCHIVE}" "${BINARY}"
            fi
          else
            chmod +x "${BINARY}"
            ARCHIVE="${NAME}.tar.gz"
            tar -czf "${ARCHIVE}" "${BINARY}"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: trovl-${{ matrix.display_name }}-${{ matrix.arch }}
          path: |
            *.zip
            *.tar.gz
          retention-days: 1
          if-no-files-found: error

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: trovl-*
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum $(ls *.zip *.tar.gz | sort) > checksums.txt

      - uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.zip
            artifacts/*.tar.gz
            artifacts/checksums.txt
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
